<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgriDoot - Gyan AI</title>
    <link rel="icon" type="image/x-icon" href="/img/agfav.ico" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- ‚úÖ Stable Cropper CDN (FIXED) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
      body {
        margin: 0;
        font-family: Inter;
        background: #f4f7fb;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        padding: 16px 24px;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
      }

      main {
        flex: 1;
        max-width: 900px;
        margin: auto;
        width: 100%;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .chat-container {
        flex: 1;
        background: white;
        border-radius: 20px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      }

      .samples {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
      }

      .sample-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        font-size: 13px;
        cursor: pointer;
      }

      .sample-btn:hover {
        background: #f0fdf4;
        border-color: #22c55e;
        color: #16a34a;
      }

      .chat-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 14px;
      }

      .user {
        align-self: flex-end;
        background: #22c55e;
        color: white;
      }

      .ai {
        align-self: flex-start;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
      }

      .chat-input {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      textarea {
        flex: 1;
        resize: none;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .plus-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      button {
        background: #22c55e;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 12px;
        cursor: pointer;
      }

      button:hover {
        background: #16a34a;
      }

      .image-preview {
        margin-top: 10px;
        display: none;
      }

      .image-preview img {
        max-width: 220px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
      }

      .image-actions {
        margin-top: 8px;
        display: flex;
        gap: 10px;
      }

      #cropModal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      #cropBox {
        background: white;
        padding: 20px;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
      }

      #cropImage {
        max-width: 100%;
        display: block;
      }
    </style>
  </head>

  <body>
    <header>üå± Gyan AI ‚Ä¢ Smart Farming Assistant</header>

    <main>
      <div class="chat-container">
        <div id="samples" class="samples"></div>
        <div id="chat_box" class="chat-body"></div>

        <div class="image-preview" id="imagePreview">
          <img id="previewImg" />
          <div class="image-actions">
            <button onclick="openCrop()">Crop</button>
            <button style="background: #ef4444" onclick="cancelImage()">
              Cancel
            </button>
          </div>
        </div>

        <div class="chat-input">
          <div class="plus-btn" onclick="triggerImage()">+</div>
          <input
            type="file"
            id="vision_image"
            hidden
            accept="image/*"
            onchange="selectImage(event)"
          />
          <textarea
            id="chat_query"
            rows="1"
            placeholder="Ask about crops, soil, weather..."
          ></textarea>
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </main>

    <!-- Crop Modal -->
    <div id="cropModal">
      <div id="cropBox">
        <h3>Crop Image</h3>
        <img id="cropImage" />
        <div
          style="
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
          "
        >
          <button
            onclick="closeCrop()"
            style="background: #e5e7eb; color: black"
          >
            Cancel
          </button>
          <button onclick="applyCrop()">Crop & Use</button>
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_USER_ID = 14;

      let cropper = null;
      let selectedImageFile = null;
      let croppedBlob = null;

      /* Random Questions */
      const questions = [
        "Wheat yellow rust treatment?",
        "Best fertilizer for paddy crop?",
        "How to increase tomato yield?",
        "Organic pest control methods?",
        "Soil testing importance?",
        "Drip irrigation benefits?",
        "Best time to sow mustard?",
        "Cotton leaf curl disease solution?",
      ];

      function loadSamples() {
        const shuffled = [...questions].sort(() => 0.5 - Math.random());
        const container = document.getElementById("samples");
        container.innerHTML = "";
        shuffled.slice(0, 5).forEach((q) => {
          const btn = document.createElement("div");
          btn.className = "sample-btn";
          btn.innerText = q;
          btn.onclick = () => {
            chat_query.value = q;
          };
          container.appendChild(btn);
        });
      }
      loadSamples();

      /* Enter to send */
      chat_query.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      /* Image Selection */
      function triggerImage() {
        vision_image.click();
      }

      function selectImage(e) {
        const file = e.target.files[0];
        if (!file) return;

        selectedImageFile = file;
        croppedBlob = null;

        previewImg.src = URL.createObjectURL(file);
        imagePreview.style.display = "block";
      }

      /* Cancel Image */
      function cancelImage() {
        vision_image.value = "";
        selectedImageFile = null;
        croppedBlob = null;
        imagePreview.style.display = "none";
      }

      /* Open Crop */
      function openCrop() {
        if (!selectedImageFile) return;

        const img = document.getElementById("cropImage");
        img.src = previewImg.src;
        cropModal.style.display = "flex";

        img.onload = function () {
          if (cropper) {
            cropper.destroy();
          }

          cropper = new Cropper(img, {
            viewMode: 1,
            autoCropArea: 1,
            responsive: true,
            background: false,
          });
        };
      }

      /* Close Crop */
      function closeCrop() {
        cropModal.style.display = "none";
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      }

      /* Apply Crop */
      function applyCrop() {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas();

        canvas.toBlob(
          function (blob) {
            if (!blob) return alert("Crop failed");

            croppedBlob = new File([blob], "cropped.jpg", {
              type: "image/jpeg",
            });

            previewImg.src = canvas.toDataURL("image/jpeg", 0.9);
            closeCrop();
          },
          "image/jpeg",
          0.9,
        );
      }

      /* Send Message */
      function renderMarkdown(text) {
        return marked.parse(text, { breaks: true, gfm: true });
      }

      function sendMessage() {
        const text = chat_query.value.trim();
        const img = croppedBlob || selectedImageFile;

        if (!text && !img) return;

        if (text) {
          chat_box.innerHTML += `<div class="bubble user">${text}</div>`;
        }

        if (img) {
          chat_box.innerHTML += `<div class="bubble user"><img src="${previewImg.src}" style="max-width:200px;border-radius:12px;"></div>`;
        }

        chat_query.value = "";
        imagePreview.style.display = "none";

        selectedImageFile = null;
        croppedBlob = null;

        const ai = document.createElement("div");
        ai.className = "bubble ai";
        ai.innerHTML = "‚è≥ Thinking...";
        chat_box.appendChild(ai);
        chat_box.scrollTop = chat_box.scrollHeight;

        const fd = new FormData();
        fd.append("user_id", DEFAULT_USER_ID);

        if (img) {
          fd.append("image", img, "cropped.jpg");
          fetch("https://api.novosedge.xyz:4433/ad/v1.5/gyan/vision", {
            method: "POST",
            headers: {
              "X-API-KEY": "agridoot_2307e123cefd632b33b4ce9ff9bef7db",
            },
            body: fd,
          })
            .then((r) => r.json())
            .then((d) => (ai.innerHTML = renderMarkdown(d.dronaVis.ans)))
            .catch(() => (ai.innerHTML = "‚ùå Vision error"));
        } else {
          fd.append("query", text);
          fetch("https://api.novosedge.xyz:4433/ad/v1.5/gyan", {
            method: "POST",
            headers: {
              "X-API-KEY": "agridoot_2307e123cefd632b33b4ce9ff9bef7db",
            },
            body: fd,
          })
            .then((r) => r.json())
            .then((d) => (ai.innerHTML = renderMarkdown(d.dronaRes.ans)))
            .catch(() => (ai.innerHTML = "‚ùå Chat error"));
        }
      }
    </script>
  </body>
</html>
